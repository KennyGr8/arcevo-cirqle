name: ğŸš€ Deploy ArcevoCirqle (Next.js)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      NEXT_PUBLIC_APP_ENV: production
      NEXT_PUBLIC_API_URL: https://placeholder.local/api
      NEXT_PUBLIC_SITE_URL: https://placeholder.local
      NEXT_TELEMETRY_DISABLED: 1

    steps:
      # ğŸ§± Checkout repository
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # âš™ï¸ Setup Node.js with PNPM
      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install PNPM globally
        run: npm install -g pnpm

      # ğŸ—‚ Install dependencies
      - name: ğŸ—‚ Install dependencies
        run: pnpm install --frozen-lockfile

      # ğŸŒ€ Restore Turborepo cache
      - name: ğŸŒ€ Restore Turborepo cache
        uses: actions/cache@v3
        with:
          path: |
            .turbo
            node_modules
            apps/web/node_modules
            packages/**/node_modules
          key: turbo-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml') }}

      # ğŸ—ï¸ Build Only If Relevant Files Changed
      - name: ğŸ—ï¸ Build Cirqle Web App
        working-directory: apps/web
        if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
        run: |
          echo "ğŸ’¡ Checking if 'apps/web' changed..."
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^apps/web/' ; then
            echo "ğŸ”¨ Changes detected in web app. Running build..."
            pnpm build
          else
            echo "âš¡ No changes in web app. Skipping build."
          fi

      # ğŸ”¥ Deploy to Render
      - name: ğŸš€ Deploy to Render
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -n "$RENDER_SERVICE_ID" ] && [ -n "$RENDER_API_KEY" ]; then
            echo "ğŸ”„ Triggering Render deploy..."
            curl -X POST https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys \
              -H "Accept: application/json" \
              -H "Authorization: Bearer $RENDER_API_KEY"
          else
            echo "âš ï¸ Render secrets not found. Skipping Render deploy."
          fi

      # ğŸŒ Deploy to Netlify (only if build ran)
      - name: ğŸŒ Deploy to Netlify
        working-directory: apps/web
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          if [ -n "$NETLIFY_AUTH_TOKEN" ] && [ -n "$NETLIFY_SITE_ID" ]; then
            if [ -d ".next" ] || [ -d "out" ]; then
              echo "ğŸŒ Deploying to Netlify..."
              pnpm dlx netlify-cli deploy --prod --dir=out \
                --auth="$NETLIFY_AUTH_TOKEN" --site="$NETLIFY_SITE_ID"
            else
              echo "âš¡ No build artifacts. Skipping Netlify deploy."
            fi
          else
            echo "âš ï¸ Netlify secrets not found. Skipping Netlify deploy."
          fi

      # âœ… Summary
      - name: âœ… Deployment summary
        if: always()
        run: echo "âœ… Deployment workflow completed successfully!"
